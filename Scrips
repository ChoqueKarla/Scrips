#!/usr/bin/env bash
# scripts.sh
# Este script debe ejecutarse directamente en el servidor (no pide usuario@host)
# Ejemplo de uso:
#   chmod +x scripts.sh
#   ./scripts.sh

set -euo pipefail

echo "=== üîÑ ACTUALIZANDO EL SISTEMA ==="
sudo apt update -y
sudo apt upgrade -y
sudo apt dist-upgrade -y
sudo apt autoremove -y
sudo apt clean

echo "=== ‚öôÔ∏è INSTALANDO DEPENDENCIAS B√ÅSICAS ==="
sudo apt install -y software-properties-common ca-certificates lsb-release apt-transport-https curl gnupg

echo "=== üß© AGREGANDO REPOSITORIO PHP (Ond≈ôej Sur√Ω) ==="
if ! sudo add-apt-repository -y ppa:ondrej/php; then
  echo "‚ö†Ô∏è No se pudo a√±adir el PPA ondrej/php. Continuando..."
fi

sudo apt update -y

PHP_VERSION="8.4"

echo "=== üåê INSTALANDO APACHE, PHP Y MARIADB ==="
sudo apt install -y apache2 mariadb-server mariadb-client \
  "php${PHP_VERSION}" "libapache2-mod-php${PHP_VERSION}" \
  "php${PHP_VERSION}-fpm" "php${PHP_VERSION}-mysqli" \
  "php${PHP_VERSION}-xml" "php${PHP_VERSION}-mbstring" \
  "php${PHP_VERSION}-curl" "php${PHP_VERSION}-zip" "php${PHP_VERSION}-gd" || {
    echo "‚ö†Ô∏è No se pudo instalar PHP ${PHP_VERSION}, instalando versi√≥n disponible..."
    sudo apt install -y php libapache2-mod-php php-mysql php-xml php-mbstring php-curl php-zip php-gd
  }

echo "=== üöÄ HABILITANDO SERVICIOS ==="
sudo systemctl enable --now apache2
sudo systemctl enable --now mariadb || true
if command -v php${PHP_VERSION}-fpm >/dev/null 2>&1; then
  sudo systemctl enable --now php${PHP_VERSION}-fpm || true
fi

echo "=== üë• CREANDO USUARIOS DEL SISTEMA ==="
for u in noelia jaime; do
  if id "$u" >/dev/null 2>&1; then
    echo "Usuario $u ya existe, saltando."
  else
    sudo useradd -m -s /bin/bash "$u"
    echo "${u}:${u}" | sudo chpasswd
    echo "Usuario $u creado con contrase√±a '$u'"
  fi
done

echo "=== üîí CONFIGURANDO FIREWALL (UFW) ==="
if command -v ufw >/dev/null 2>&1; then
  sudo ufw allow OpenSSH || true
  sudo ufw allow 'Apache Full' || true
  sudo ufw --force enable || true
fi

echo "=== üßæ CREANDO P√ÅGINA DE PRUEBA PHP ==="
echo "<?php phpinfo(); ?>" | sudo tee /var/www/html/info.php >/dev/null
sudo chown -R www-data:www-data /var/www/html
sudo systemctl reload apache2

echo "‚úÖ Instalaci√≥n completada con √©xito."
echo "üëâ Prueba en tu navegador: http://$(hostname -I | awk '{print $1}')/info.php"
echo "Usuarios creados: noelia / jaime (contrase√±a igual al nombre)"
