#!/usr/bin/env bash
# instalar-servidor.sh
# Este script se debe ejecutar directamente en el servidor.

set -euo pipefail

echo "=== VERIFICANDO E INSTALANDO OPENSSH ==="
if ! command -v ssh >/dev/null 2>&1; then
  echo "Instalando OpenSSH..."
  sudo apt-get update -y
  sudo apt-get install -y openssh-server
else
  echo "OpenSSH ya está instalado."
fi

# Asegurar que SSH use el puerto 22
if grep -qE '^#?Port ' /etc/ssh/sshd_config; then
  sudo sed -i 's/^#\?Port .*/Port 22/' /etc/ssh/sshd_config
else
  echo "Port 22" | sudo tee -a /etc/ssh/sshd_config >/dev/null
fi

# Verificar si el puerto 22 está ocupado
if sudo lsof -i:22 >/dev/null 2>&1; then
  echo "⚠️ Advertencia: El puerto 22 ya está en uso. Se intentará reiniciar SSH de todas formas..."
else
  echo "✅ El puerto 22 está libre."
fi

# Habilitar y reiniciar el servicio SSH
sudo systemctl enable ssh
sudo systemctl restart ssh
sudo systemctl status ssh --no-pager || true

echo "=== ACTUALIZANDO SISTEMA ==="
sudo apt-get update -y
sudo apt-get upgrade -y
sudo apt-get dist-upgrade -y
sudo apt-get autoremove -y
sudo apt-get clean

echo "=== INSTALANDO DEPENDENCIAS BÁSICAS ==="
sudo apt-get install -y software-properties-common ca-certificates lsb-release apt-transport-https curl gnupg

echo "=== AGREGANDO REPOSITORIO PHP ==="
if ! sudo add-apt-repository -y ppa:ondrej/php; then
  echo "⚠️ No se pudo añadir el PPA ondrej/php. Continuando..."
fi

sudo apt-get update -y

PHP_VERSION="8.4"

echo "=== INSTALANDO APACHE, PHP Y MARIADB ==="
sudo apt-get install -y apache2 mariadb-server mariadb-client \
  "php${PHP_VERSION}" "libapache2-mod-php${PHP_VERSION}" \
  "php${PHP_VERSION}-fpm" "php${PHP_VERSION}-mysqli" \
  "php${PHP_VERSION}-xml" "php${PHP_VERSION}-mbstring" \
  "php${PHP_VERSION}-curl" "php${PHP_VERSION}-zip" "php${PHP_VERSION}-gd" || {
    echo "⚠️ No se pudo instalar PHP ${PHP_VERSION}, instalando versión disponible..."
    sudo apt-get install -y php libapache2-mod-php php-mysql php-xml php-mbstring php-curl php-zip php-gd
  }

echo "=== HABILITANDO SERVICIOS ==="
sudo systemctl enable --now apache2
sudo systemctl enable --now mariadb || true
if command -v php${PHP_VERSION}-fpm >/dev/null 2>&1; then
  sudo systemctl enable --now php${PHP_VERSION}-fpm || true
fi

echo "=== CREANDO USUARIOS DEL SISTEMA ==="
for u in noelia jaime; do
  if id "$u" >/dev/null 2>&1; then
    echo "Usuario $u ya existe, saltando."
  else
    sudo useradd -m -s /bin/bash "$u"
    echo "${u}:${u}" | sudo chpasswd
    echo "Usuario $u creado con contraseña '$u'"
  fi
done

echo "=== CONFIGURANDO FIREWALL (UFW) ==="
if command -v ufw >/dev/null 2>&1; then
  sudo ufw allow 22/tcp || true
  sudo ufw allow 'Apache Full' || true
  sudo ufw --force enable || true
fi

echo "=== CREANDO PÁGINA DE PRUEBA PHP ==="
echo "<?php phpinfo(); ?>" | sudo tee /var/www/html/info.php >/dev/null
sudo chown -R www-data:www-data /var/www/html
sudo systemctl reload apache2

echo "✅ Instalación completada correctamente."
echo "Puedes acceder por SSH (puerto 22) o visitar http://<tu_servidor>/info.php para probar PHP."
